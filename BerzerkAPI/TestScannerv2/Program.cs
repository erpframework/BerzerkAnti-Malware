using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;
//new 
using BerzerkAPI.Analyzers;
using BerzerkAPI.Controllers;
using BerzerkAPI.IO;
using BerzerkAPI.Models;

//More new...
using System.IO;
using System.Threading;
using System.Diagnostics;
namespace TestScannerv2
{
    class Program
    {
        static List<ThreatDetectedArgs> Threats { get; set; }
        static Stopwatch watch { get; set; }
        static int DetectionCount { get; set; }
        static int TotalFiles { get; set; }

        static void Main(string[] args)
        {
            // Output some information about the program running 
            Console.Title = "Berzerk Malware Scanner 2 - Test Client - http://JordanHook.com";

            // Output version of tester 
            Console.WriteLine("Berzerk Malware Scanner Test Client 2.0");

            // Scan a folder based on the args 
            if (args.Length == 0)
            {
                Console.WriteLine("No scan directory specified...");
                return;
            }

            // Declare some variables for the scan 
            string ScanDirectory = args[0];

            // Our controllers... 
            SignatureController Signatures = new SignatureController("sigs.sdb");
            CachedController Cached = new CachedController("cached.cdb");

            // Load the library setting defaults (we will add a settings controller later...)
            BerzerkAPI.Settings.Defaults();

            //Set max file size to 5mb to testing purposes..
            BerzerkAPI.Settings.MaxFileSize = (1024 * 1024) * 5;

            // Try to load the signatures 
            if (Signatures.LoadDatabase())
            {
                Console.WriteLine("Signature database was loaded with {0} entries", Signatures.Signatures.Count);
            }
            else
            {
                // If the signatures can't be loaded... we can't scan for anything 
                Console.WriteLine("Unable to load signature database...");
                return;
            }

            // Try to load the cached file database
            try
            {
                if (Cached.LoadDatabase())
                {
                    Console.WriteLine("Cached database was loaded with {0} entries", Cached.CachedFiles.Count);
                }
            }
            catch (Exception)
            {
                // No cached database exists yet... 
                System.IO.File.Create("cached.cdb");

                // Lets set a db version 1 for now... 
                Cached.SetDbVersion(1);
            }

            // Output current task
            Console.WriteLine("\nGathering files to scan...");

            // Now that our controllers have been loaded... we can attempt to start scanning files 
            Queue<string> ScanList = BerzerkAPI.IO.File.CreateFileQueue(ScanDirectory, true);
            Threats = new List<ThreatDetectedArgs>(); 

            // Store total files to scan...
            TotalFiles = ScanList.Count; 

            // Output current task 
            Console.WriteLine("\nScanning {0} files...", ScanList.Count);

            // Create an instance of the scan controller to work with 
            ScanController scanner = new ScanController(ScanList, Signatures, Cached);

            // Setup events
            scanner.ThreatDetected += Scanner_ThreatDetected;
            scanner.ThreatScanComplete += Scanner_ThreatScanComplete;

            // setup watch
            watch = new Stopwatch();

            // Background reporting..
            new Thread(() =>
            {
                Thread.Sleep(1000);

                // Output some information about the current scan... 
                while (scanner.Scanning)
                {
                    Console.WriteLine("{0}/{1} Files scanned\t{2:0.00} MB Processed\t{3}", TotalFiles - scanner.TargetFiles.Count, TotalFiles, scanner.ScannedData, watch.Elapsed.ToString());
                    Thread.Sleep(1000);
                }
            }).Start();


            // start the watch
            watch.Start();

            // Start the scan 
            scanner.Run();

            // Keep the program open 
            System.Diagnostics.Process.GetCurrentProcess().WaitForExit(); 
        }

        private static void Scanner_ThreatScanComplete(ScanController sender)
        {
            // stop the watch
            watch.Stop();

            // Notify user 
            Console.WriteLine("\n\n\nScan complete...");

            // Calc rate
            double rate = ((double)DetectionCount / (double)TotalFiles) * 100.0;

            // Display detection rate (this is only a valid rating if you are scanning a folder of malware only) 
            Console.WriteLine("{0} / {1} Files detected...", DetectionCount, TotalFiles);
            Console.WriteLine("If the files are all malcious, your database is providing a {0:0.00} detection rate.", rate);
            Console.WriteLine("{0} Files Scanned, {1:0.00}MB Processed", TotalFiles, sender.ScannedData);
            Console.WriteLine("Total Time: {0}", watch.Elapsed);

            // If threats were detected 
            if(DetectionCount > 0)
            {
                // Advise user 
                Console.WriteLine("\n\nPress any key to see the list of threats detected...");
                Console.ReadKey();

                Console.Clear();
                Console.WriteLine("Threats: ");
                
                // Display list of threats and their locations 
                foreach(ThreatDetectedArgs t in Threats)
                {
                    Console.WriteLine("\nTHREAT DETECT: {0}\n{1}", t.Detection.Definition, t.FilePath);
                }

                Console.WriteLine("\n\nYou may now exit...");
            }
        }

        private static void Scanner_ThreatDetected(ScanController sender, ThreatDetectedArgs args)
        {
            // Notify user 
            //Console.WriteLine("\nTHREAT DETECT: {0}\n{1}", args.Detection.Definition, args.FilePath);

            // Add threat detection to list 
            Threats.Add(args); 

            // increase amount of detected files 
            DetectionCount++; 
        }
    }
}
