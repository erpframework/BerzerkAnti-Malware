using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

using System.IO;
using System.Diagnostics;

namespace BerzerkAPI.API
{
    public class UPXHelper
    {
        public static string UnpackFile(string location)
        {
            // Create a temp file 
            string temp = Path.GetTempFileName();
            //string temp = location + ".unpacked"; 

            // delete the originally created fille 
            File.Delete(temp);

            // set unpacked so it's scannable 
            temp = temp + ".unpacked";

            // add the file to the white list for a few momemnts... 
            Settings.WhiteList.Add(temp); 

            // Copy the target file to the tmp location
            // File.Copy(location, temp);

            ProcessStartInfo psi = new ProcessStartInfo();
            psi.FileName = "tools\\upx.exe";
            psi.CreateNoWindow = true;
            psi.RedirectStandardInput = true;
            psi.RedirectStandardOutput = false;
            psi.Arguments = "-d \"" + location + "\" -o \"" + temp + "\"";
            psi.UseShellExecute = false;

            string full = Path.GetFullPath(psi.FileName);

            if (location != full)
            {
                Process.Start(psi).WaitForExit();
            }
            else
            {
                File.Delete(temp); 
            }

            return temp; 
        }
    }
}
